---
import BaseLayout from '@layouts/BaseLayout.astro';
import Navbar from '@components/Navbar.astro';
import stringsTr from '@i18n/tr.json';
import stringsEn from '@i18n/en.json';
import stringsPl from '@i18n/pl.json';
import { isLang, type Lang } from '@lib/i18n';
import { langStaticPaths } from '@lib/staticPaths';
import { loadSettings, loadPlaces, loadTestimonials } from '@lib/content';
import HomeHero from '@sections/HomeHero.astro';
import PlacesSection from '@sections/PlacesSection.astro';
import GallerySection from '@sections/GallerySection.astro';
import AboutSection from '@sections/AboutSection.astro';
import TestimonialsSection from '@sections/TestimonialsSection.astro';
import ContactSection from '@sections/ContactSection.astro';

export const getStaticPaths = langStaticPaths;

const langParam = Astro.params.lang;
const lang: Lang = isLang(langParam) ? (langParam as Lang) : 'tr';
const dict = lang === 'en' ? stringsEn : lang === 'pl' ? stringsPl : stringsTr;
const BASE = (import.meta.env.BASE_URL || '/').replace(/\/?$/, '/');
const site = import.meta.env.SITE || 'http://localhost:4321';
const alternates = [
  { hrefLang: 'tr', href: new URL(`${BASE}tr/`, site).toString() },
  { hrefLang: 'en', href: new URL(`${BASE}en/`, site).toString() },
  { hrefLang: 'pl', href: new URL(`${BASE}pl/`, site).toString() },
  { hrefLang: 'x-default', href: new URL(`${BASE}tr/`, site).toString() },
];
const description = 'Licensed tour guide in Istanbul. Private tours in TR/EN/PL.';

const settings = loadSettings();
const places = loadPlaces(lang);
const testimonials = loadTestimonials(lang);
const reviewCount = testimonials.length;
const averageRating = reviewCount ? (
  testimonials.reduce((sum: number, t: any) => sum + (Number(t.rating) || 0), 0) / reviewCount
).toFixed(1) : undefined;
const whatsapp = settings.whatsapp_number || '+90XXXXXXXXXX';
const email = settings.email || 'yusuf.ozkan@example.com';
const waHref = `https://wa.me/${whatsapp.replace(/[^+\d]/g,'')}?text=${encodeURIComponent('Merhaba! Özel tur hakkında bilgi almak istiyorum.')}`;
---
<BaseLayout title={dict.siteTitle} lang={lang}>
  <Fragment slot="head">
    <meta name="description" content={description} />
    <link rel="canonical" href={new URL(`${BASE}${lang}/`, site).toString()} />
    <link rel="alternate" hrefLang="tr" href={alternates[0].href} />
    <link rel="alternate" hrefLang="en" href={alternates[1].href} />
    <link rel="alternate" hrefLang="pl" href={alternates[2].href} />
    <link rel="alternate" hrefLang="x-default" href={alternates[3].href} />
    {averageRating && (
      <script type="application/ld+json">{JSON.stringify({
        '@context': 'https://schema.org',
        '@type': 'AggregateRating',
        itemReviewed: {
          '@type': 'LocalBusiness',
          name: settings.owner_name || 'Yusuf Özkan',
          url: new URL(`${BASE}${lang}/`, site).toString()
        },
        ratingValue: Number(averageRating),
        reviewCount
      })}</script>
    )}
    <script type="application/ld+json">{JSON.stringify({
      '@context': 'https://schema.org',
      '@type': 'LocalBusiness',
      name: settings.owner_name || 'Yusuf Özkan',
      description,
      url: new URL(`${BASE}${lang}/`, site).toString(),
      areaServed: 'Istanbul',
      email: settings.email,
      sameAs: Object.values(settings.socials || {}).filter(Boolean),
    })}</script>
  </Fragment>
  <Navbar lang={lang} />
  <main>
    <HomeHero lang={lang} title="Discover the Magic of Istanbul" subtitle="Your personal guide to the heart of history and culture." waHref={waHref} ctaPrimary={dict.cta.primary} ctaSecondary={dict.cta.secondary} />
    <PlacesSection lang={lang} places={places} />
    <GallerySection />
    <AboutSection ownerName={settings.owner_name} ownerTitle={settings.owner_title} />
    <TestimonialsSection testimonials={testimonials} />
    <ContactSection waHref={waHref} email={email} />
  </main>
</BaseLayout>
